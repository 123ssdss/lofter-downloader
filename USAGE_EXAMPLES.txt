================================================================
é‡æ„åè¯„è®ºæ¨¡å—ä½¿ç”¨ç¤ºä¾‹
================================================================

================================================================
ä¸€ã€åŸºç¡€ä½¿ç”¨ï¼ˆæ¨èæ–¹å¼ï¼‰
================================================================

ã€ç¤ºä¾‹1: è·å–å¹¶æ ¼å¼åŒ–è¯„è®ºã€‘
from network import LofterClient
from processors.comment_processor_refactored import process_comments

# åˆ›å»ºå®¢æˆ·ç«¯
cookies = {
    "LOFTER-PHONE-LOGIN-AUTH": "your_token",
    # ... å…¶ä»–cookies
}
client = LofterClient(cookies=cookies, debug=True)

# è·å–è¯„è®º
post_id = "1e8d5a0b_1234567"
blog_id = "testblog"
comments_text = process_comments(client, post_id, blog_id, mode='tag', name='art')

print(comments_text)


ã€ç¤ºä¾‹2: å¤„ç†å•ä¸ªå¸–å­çš„è¯„è®ºæ¨¡å¼ã€‘
from network import LofterClient
from processors.comment_mode_processor_refactored import process_comment_mode

client = LofterClient(cookies=cookies)

# ä½¿ç”¨URL
post_url = "https://testblog.lofter.com/post/1e8d5a0b_1234567"
process_comment_mode(client, post_url)

# æˆ–è€…ç›´æ¥ä½¿ç”¨ID
process_comment_mode(client, "1e8d5a0b_1234567", blog_id="testblog")


================================================================
äºŒã€é«˜çº§ä½¿ç”¨ï¼ˆæ¨¡å—åŒ–æ–¹å¼ï¼‰
================================================================

ã€ç¤ºä¾‹3: åˆ†æ­¥å¤„ç†è¯„è®ºã€‘
from network import LofterClient
from processors.comment_fetcher import CommentFetcher
from processors.comment_formatter import CommentFormatter
from processors.comment_saver import CommentSaver

client = LofterClient(cookies=cookies, debug=True)

# æ­¥éª¤1: è·å–è¯„è®ºæ•°æ®
fetcher = CommentFetcher(client)
structured_comments = fetcher.fetch_all_comments(post_id, blog_id)

# æŸ¥çœ‹è¯„è®ºæ•°é‡
hot_count = len(structured_comments.get("hot_list", []))
all_count = len(structured_comments.get("all_list", []))
print(f"çƒ­é—¨è¯„è®º: {hot_count} æ¡")
print(f"å…¨éƒ¨è¯„è®º: {all_count} æ¡")

# æ­¥éª¤2: ä¿å­˜è¯„è®º
saver = CommentSaver(client)
saver.save_comments(post_id, blog_id, structured_comments, mode='tag', name='art')

# æ­¥éª¤3: æ ¼å¼åŒ–è¯„è®º
formatter = CommentFormatter()
formatted_text = formatter.format_comments(structured_comments)
print(formatted_text)


ã€ç¤ºä¾‹4: è‡ªå®šä¹‰æ ¼å¼åŒ–ã€‘
from processors.comment_formatter import CommentFormatter

class CustomFormatter(CommentFormatter):
    """è‡ªå®šä¹‰æ ¼å¼åŒ–å™¨"""
    
    def _format_single_comment(self, comment, indent_level=0):
        """è‡ªå®šä¹‰å•ä¸ªè¯„è®ºçš„æ ¼å¼"""
        indent = "  " * indent_level
        author = comment.get("author", {}).get("blogNickName", "Unknown")
        content = comment.get('content', '').strip()
        likes = comment.get('likeCount', 0)
        
        # è‡ªå®šä¹‰æ ¼å¼
        result = f"{indent}ã€{author}ã€‘: {content} (ğŸ‘ {likes})\n"
        return result

# ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼åŒ–å™¨
custom_formatter = CustomFormatter()
custom_text = custom_formatter.format_comments(structured_comments)


ã€ç¤ºä¾‹5: æ‰¹é‡å¤„ç†å¤šä¸ªå¸–å­ã€‘
from processors.comment_fetcher import CommentFetcher
from processors.comment_formatter import CommentFormatter
from processors.comment_saver import CommentSaver
import time

client = LofterClient(cookies=cookies)
fetcher = CommentFetcher(client)
formatter = CommentFormatter()
saver = CommentSaver(client)

# å¸–å­åˆ—è¡¨
posts = [
    {"post_id": "123", "blog_id": "blog1"},
    {"post_id": "456", "blog_id": "blog2"},
    {"post_id": "789", "blog_id": "blog3"},
]

for post in posts:
    print(f"å¤„ç†å¸–å­: {post['post_id']}")
    
    # è·å–è¯„è®º
    comments = fetcher.fetch_all_comments(post["post_id"], post["blog_id"])
    
    # ä¿å­˜
    saver.save_comments(post["post_id"], post["blog_id"], comments, mode='blog')
    
    # æ ¼å¼åŒ–å¹¶æ‰“å°
    text = formatter.format_comments(comments)
    print(f"è¯„è®ºæ•°: {len(comments.get('all_list', []))}")
    
    # è¯·æ±‚é—´éš”
    time.sleep(1)


================================================================
ä¸‰ã€é”™è¯¯å¤„ç†ç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹6: å¤„ç†ç½‘ç»œé”™è¯¯ã€‘
from processors.comment_fetcher import CommentFetcher

client = LofterClient(cookies=cookies, debug=True)
fetcher = CommentFetcher(client)

try:
    comments = fetcher.fetch_all_comments(post_id, blog_id)
    
    if not comments or not comments.get("all_list"):
        print("æœªæ‰¾åˆ°è¯„è®º")
    else:
        print(f"æˆåŠŸè·å– {len(comments['all_list'])} æ¡è¯„è®º")
        
except Exception as e:
    print(f"è·å–è¯„è®ºå¤±è´¥: {e}")
    # é‡è¯•é€»è¾‘å·²å†…ç½®åœ¨fetcherä¸­ï¼Œè¿™é‡Œå¯ä»¥è®°å½•æ—¥å¿—


ã€ç¤ºä¾‹7: å¤„ç†æ— æ•ˆæ•°æ®ã€‘
from processors.comment_formatter import CommentFormatter

formatter = CommentFormatter()

# å¤„ç†ç©ºæ•°æ®
empty_comments = {"hot_list": [], "all_list": []}
text = formatter.format_comments(empty_comments)
print(text)  # è¾“å‡º: "[çƒ­é—¨è¯„è®º]\n\n[å…¨éƒ¨è¯„è®º]\n"

# å¤„ç†None
text = formatter.format_comments(None)
print(text)  # è¾“å‡º: ""


================================================================
å››ã€é…ç½®ä½¿ç”¨ç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹8: åˆ‡æ¢è¯„è®ºæ ¼å¼ã€‘
# åœ¨ config.py ä¸­ä¿®æ”¹
GROUP_COMMENTS_BY_QUOTE = True   # æŒ‰å¼•ç”¨åˆ†ç»„
# GROUP_COMMENTS_BY_QUOTE = False  # æŒ‰åŸå§‹é¡ºåº

from processors.comment_formatter import CommentFormatter

formatter = CommentFormatter()
# formatter ä¼šè‡ªåŠ¨ä½¿ç”¨é…ç½®çš„æ ¼å¼


ã€ç¤ºä¾‹9: è°ƒæ•´å¹¶å‘æ•°ã€‘
# åœ¨ config.py ä¸­ä¿®æ”¹
COMMENT_MAX_WORKERS = 5  # è¯„è®ºå¤„ç†çš„æœ€å¤§çº¿ç¨‹æ•°
L2_COMMENT_REQUEST_DELAY = 1  # L2è¯„è®ºè¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰

# é…ç½®ä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é¢å¤–ä»£ç 


================================================================
äº”ã€è°ƒè¯•ç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹10: å¯ç”¨è¯¦ç»†æ—¥å¿—ã€‘
from network import LofterClient
from processors.comment_fetcher import CommentFetcher

# å¯ç”¨è°ƒè¯•æ¨¡å¼
client = LofterClient(cookies=cookies, debug=True)
fetcher = CommentFetcher(client)

# æ‰€æœ‰ç½‘ç»œè¯·æ±‚å’Œå¤„ç†è¿‡ç¨‹éƒ½ä¼šè¾“å‡ºæ—¥å¿—
comments = fetcher.fetch_all_comments(post_id, blog_id)


ã€ç¤ºä¾‹11: æ£€æŸ¥è¯„è®ºç»“æ„ã€‘
import json
from processors.comment_fetcher import CommentFetcher

client = LofterClient(cookies=cookies)
fetcher = CommentFetcher(client)

comments = fetcher.fetch_all_comments(post_id, blog_id)

# æ‰“å°ç»“æ„åŒ–æ•°æ®
print(json.dumps(comments, ensure_ascii=False, indent=2))

# æ£€æŸ¥æ¯ä¸ªè¯„è®ºçš„å­—æ®µ
for comment in comments["all_list"]:
    print(f"è¯„è®ºID: {comment['id']}")
    print(f"ä½œè€…: {comment['author']['blogNickName']}")
    print(f"å†…å®¹: {comment['content'][:50]}...")
    print(f"å›å¤æ•°: {len(comment['replies'])}")
    print("-" * 40)


================================================================
å…­ã€æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹12: ä½¿ç”¨ç¼“å­˜ï¼ˆç¤ºä¾‹ä»£ç ï¼‰ã€‘
from processors.comment_fetcher import CommentFetcher
import json
import os

class CachedCommentFetcher(CommentFetcher):
    """å¸¦ç¼“å­˜çš„è¯„è®ºè·å–å™¨"""
    
    def __init__(self, client, cache_dir="cache"):
        super().__init__(client)
        self.cache_dir = cache_dir
        os.makedirs(cache_dir, exist_ok=True)
    
    def fetch_all_comments(self, post_id, blog_id, max_retries=3):
        # æ£€æŸ¥ç¼“å­˜
        cache_file = os.path.join(self.cache_dir, f"{post_id}_{blog_id}.json")
        
        if os.path.exists(cache_file):
            print(f"ä»ç¼“å­˜åŠ è½½: {cache_file}")
            with open(cache_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        
        # ä»APIè·å–
        comments = super().fetch_all_comments(post_id, blog_id, max_retries)
        
        # ä¿å­˜åˆ°ç¼“å­˜
        with open(cache_file, 'w', encoding='utf-8') as f:
            json.dump(comments, f, ensure_ascii=False, indent=2)
        
        return comments

# ä½¿ç”¨å¸¦ç¼“å­˜çš„è·å–å™¨
client = LofterClient(cookies=cookies)
cached_fetcher = CachedCommentFetcher(client)
comments = cached_fetcher.fetch_all_comments(post_id, blog_id)


ã€ç¤ºä¾‹13: é™åˆ¶è·å–æ•°é‡ã€‘
from processors.comment_fetcher import CommentFetcher

class LimitedCommentFetcher(CommentFetcher):
    """é™åˆ¶è¯„è®ºæ•°é‡çš„è·å–å™¨"""
    
    def _fetch_all_l1_comments(self, post_id, blog_id, max_comments=50):
        """æœ€å¤šè·å–æŒ‡å®šæ•°é‡çš„è¯„è®º"""
        all_comments = []
        offset = 0
        page = 1
        
        while len(all_comments) < max_comments:
            # ... åŸæœ‰é€»è¾‘ ...
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é™åˆ¶
            if len(all_comments) >= max_comments:
                break
        
        return all_comments[:max_comments]

# ä½¿ç”¨
client = LofterClient(cookies=cookies)
limited_fetcher = LimitedCommentFetcher(client)
comments = limited_fetcher.fetch_all_comments(post_id, blog_id)


================================================================
ä¸ƒã€é›†æˆç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹14: åœ¨æ ‡ç­¾å¤„ç†å™¨ä¸­ä½¿ç”¨ã€‘
from processors.tag_processor import process_tag
from network import LofterClient

# æ ‡ç­¾å¤„ç†å™¨ä¼šè‡ªåŠ¨è°ƒç”¨é‡æ„åçš„è¯„è®ºå¤„ç†æ¨¡å—
client = LofterClient(cookies=cookies)
process_tag(
    client, 
    tag="art", 
    list_type="total",
    timelimit="",
    blog_type="1",
    download_comments=True,  # å¯ç”¨è¯„è®ºä¸‹è½½
    download_images=True
)


ã€ç¤ºä¾‹15: åœ¨åšå®¢å¤„ç†å™¨ä¸­ä½¿ç”¨ã€‘
from processors.blog_processor import process_post
from network import LofterClient

client = LofterClient(cookies=cookies)

post_meta = {
    "blogInfo": {"blogId": "testblog", "blogName": ""},
    "postData": {"postView": {"id": "1e8d5a0b_1234567"}}
}

# ä¼šè‡ªåŠ¨è·å–å¹¶ä¿å­˜è¯„è®º
process_post(
    client, 
    post_meta, 
    tag="art",
    download_comments=True,
    source_type="tag",
    download_images=True
)


================================================================
å…«ã€æµ‹è¯•ç¤ºä¾‹
================================================================

ã€ç¤ºä¾‹16: å•å…ƒæµ‹è¯•ã€‘
import unittest
from processors.comment_formatter import CommentFormatter

class TestCommentFormatter(unittest.TestCase):
    
    def setUp(self):
        self.formatter = CommentFormatter()
    
    def test_format_empty_comments(self):
        """æµ‹è¯•ç©ºè¯„è®ºæ ¼å¼åŒ–"""
        empty = {"hot_list": [], "all_list": []}
        result = self.formatter.format_comments(empty)
        self.assertIn("[çƒ­é—¨è¯„è®º]", result)
        self.assertIn("[å…¨éƒ¨è¯„è®º]", result)
    
    def test_format_single_comment(self):
        """æµ‹è¯•å•ä¸ªè¯„è®ºæ ¼å¼åŒ–"""
        comment = {
            "id": "test",
            "content": "æµ‹è¯•è¯„è®º",
            "author": {"blogNickName": "æµ‹è¯•ç”¨æˆ·"},
            "publishTimeFormatted": "2024-01-01 12:00:00",
            "likeCount": 10,
            "ipLocation": "æµ‹è¯•åœ°ç‚¹"
        }
        result = self.formatter._format_single_comment(comment)
        self.assertIn("æµ‹è¯•ç”¨æˆ·", result)
        self.assertIn("æµ‹è¯•è¯„è®º", result)

if __name__ == "__main__":
    unittest.main()


================================================================
ä¹ã€å¸¸è§é—®é¢˜è§£å†³
================================================================

é—®é¢˜1: è¯„è®ºè·å–å¤±è´¥
è§£å†³æ–¹æ¡ˆ:
- æ£€æŸ¥ cookies æ˜¯å¦æœ‰æ•ˆ
- å¯ç”¨ debug æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- å¢åŠ é‡è¯•æ¬¡æ•°
- æ£€æŸ¥ç½‘ç»œè¿æ¥

é—®é¢˜2: æ ¼å¼åŒ–è¾“å‡ºä¸æ­£ç¡®
è§£å†³æ–¹æ¡ˆ:
- æ£€æŸ¥ GROUP_COMMENTS_BY_QUOTE é…ç½®
- éªŒè¯è¯„è®ºæ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
- ä½¿ç”¨ json.dumps æŸ¥çœ‹åŸå§‹æ•°æ®

é—®é¢˜3: æ–‡ä»¶ä¿å­˜è·¯å¾„é”™è¯¯
è§£å†³æ–¹æ¡ˆ:
- æ£€æŸ¥ utils.path_manager é…ç½®
- éªŒè¯ mode å’Œ name å‚æ•°æ˜¯å¦æ­£ç¡®
- æ‰‹åŠ¨åˆ›å»ºç›®å½•ç¡®ä¿æƒé™

é—®é¢˜4: L2è¯„è®ºè·å–ä¸å®Œæ•´
è§£å†³æ–¹æ¡ˆ:
- å¢åŠ  L2_COMMENT_REQUEST_DELAY
- æ£€æŸ¥ API è¿”å›ç»“æ„
- å¯ç”¨è°ƒè¯•æ—¥å¿—æŸ¥çœ‹è¯¦æƒ…

================================================================
